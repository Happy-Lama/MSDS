{% extends 'layouts/base.html' %}
{% load static %}

{% block title %}Maize Stalk Borers Advisories FAQ{% endblock %}

<!-- Custom styles for this page -->
<link href="{% static 'vendor/datatables/dataTables.bootstrap4.min.css' %}" rel="stylesheet">  

{% block extrastyle %}
<style>
    .chat-container {
        width: 100%;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 10px;
        background-color: #f9f9f9;
        overflow-y: auto;
        max-height: 400px;
    }
    .chat-bubble {
        display: inline-block;
        max-width: 80%;
        margin: 10px;
        padding: 10px;
        border-radius: 10px;
        background-color: #e0f7fa;
        word-wrap: break-word;
    }
    .user-message {
        text-align: right;
    }
    .bot-message {
        text-align: left;
    }
    .chat-input-container {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }
    .chat-input-container input {
        width: 70%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 10px;
        margin-right: 10px;
    }
    .chat-input-container button {
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
    }
    .chat-input-container button:hover {
        background-color: #0056b3;
    }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="container-fluid">
    <!-- Chatbot Section -->
    <div class="chat-container" id="chatContainer">
        <!-- Initial greeting message -->
        <div class="chat-bubble bot-message">Hello! How can I assist you today?</div>
    </div>
    <!-- Input field for user questions -->
    <div class="chat-input-container">
        <input type="text" id="userInput" placeholder="Enter your question...">
        <button onclick="handleUserInput()">Ask</button>
    </div>
</div>

<script>
    // Function to add a user message to the chat container
    function addUserMessage(message) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-bubble user-message';
        messageDiv.textContent = message;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Function to add a bot message to the chat container
    function addBotMessage(message) {
        const chatContainer = document.getElementById('chatContainer');
        const messageDiv = document.createElement('div');
        messageDiv.className = 'chat-bubble bot-message';
        messageDiv.textContent = message;
        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // Function to handle user input
    function handleUserInput() {
        const userInput = document.getElementById('userInput').value;
        if (userInput.trim() !== '') {
            addUserMessage(userInput);
            fetchChatbotResponse(userInput);
            // Clear the input field after processing the user's question
            document.getElementById('userInput').value = '';
        }
    }

    // Function to fetch the chatbot response from the server
    function fetchChatbotResponse(question) {
        fetch("{% url 'chatbot_response' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ question: question })
        })
        .then(response => response.json())
        .then(data => {
            addBotMessage(data.response);
        })
        .catch(error => {
            console.error('Error:', error);
            addBotMessage('Sorry, there was an error processing your request.');
        });
    }

    // Function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
